/**
 * Auto-generates docs/paths-reference.md based on the current paths.js outputs.
 * This acts as an Inverted SSOT, ensuring documentation never drifts from code.
 */
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import { paths } from "../paths.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT = path.resolve(__dirname, "..");
const DOCS_DIR = path.join(ROOT, "docs");

function generateMarkdown() {
  let md = `<!-- DO NOT EDIT MANUALLY! -->
<!-- This file is auto-generated by scripts/generate-paths-docs.js -->
<!-- It reflects the actual runtime SSOT from paths.js -->

# Paths Reference (Inverted SSOT)

This document is automatically generated to reflect the canonical paths used by the MMB project.

## Current Runtime Paths

| Key | Path |
|---|---|
`;

  // Sort keys for consistent output
  const keys = Object.keys(paths).filter(k => typeof paths[k] !== 'function');
  keys.sort();

  for (const key of keys) {
    const value = paths[key];
    if (typeof value === "string") {
      md += `| \`${key}\` | \`${value}\` |\n`;
    } else if (typeof value === "object" && value !== null) {
      // e.g., Docker paths
      for (const [subKey, subValue] of Object.entries(value)) {
        md += `| \`${key}.${subKey}\` | \`${subValue}\` |\n`;
      }
    }
  }

  md += `
---
*Generated automatically. To update, modify \`paths.js\` and run \`npm run docs:paths\`.*
`;
  return md;
}

function main() {
  if (!fs.existsSync(DOCS_DIR)) {
    fs.mkdirSync(DOCS_DIR);
  }

  const outPath = path.join(DOCS_DIR, "paths-reference.md");
  fs.writeFileSync(outPath, generateMarkdown(), "utf8");
  console.log(`[docs-gen] Updated ${outPath}`);

  // Update docs/СИМЛИНКИ.txt with actual symlinks from paths.symlinksRegistry
  const symlinksTxtPath = path.join(DOCS_DIR, "СИМЛИНКИ.txt");
  if (fs.existsSync(symlinksTxtPath)) {
    let content = fs.readFileSync(symlinksTxtPath, "utf8");
    const marker = "### --- АВТОМАТИЧЕСКИЙ РЕЕСТР СИМЛИНКОВ ИЗ paths.js --- ###";
    
    // Create the auto-generated block
    let block = `\n\n${marker}\n`;
    block += `# Не редактируйте этот блок вручную, он обновляется командой npm run docs:paths\n`;
    block += `# Формат: Путь симлинка | Целевой файл\n\n`;
    
    const registry = paths.symlinksRegistry || {};
    const entries = Object.entries(registry);
    
    if (entries.length === 0) {
      block += `# (Симлинков пока нет)\n`;
    } else {
      for (const [linkPath, targetPath] of entries) {
        block += `${linkPath} | ${targetPath}\n`;
      }
    }
    
    // Replace existing block or append
    const markerIdx = content.indexOf(marker);
    if (markerIdx !== -1) {
      // Remove the old block and everything after it
      content = content.slice(0, markerIdx).trim();
    }
    
    fs.writeFileSync(symlinksTxtPath, content + block, "utf8");
    console.log(`[docs-gen] Injected auto-registry into ${symlinksTxtPath}`);
  }
}

main();
