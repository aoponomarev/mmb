# План_Skills_MCP.md

> Категория: План (документ для автора проекта, свободная форма)
> Создан: 2026-02-20
> Статус: Актуален
> Обновлять по мере прояснения архитектуры MMB

---

## Что это за документ

Этот документ фиксирует все архитектурные решения по системе управления скилами в проекте MMB.
Написан для меня (автора) — чтобы через месяц не пришлось восстанавливать логику с нуля.
Каждый пункт содержит не только "что сделано", но и "почему именно так, а не иначе".

Документ будет пополняться по мере развития проекта. Сейчас освещены только вопросы скилов.
Архитектура MCP в целом (агенты, control-plane, n8n) — отдельные документы, когда дойдём.

---

## 1. Контекст: откуда берётся MMB и зачем нужна миграция

MMB — это следующая, улучшенная версия проекта MBB
(`D:\Clouds\AO\OneDrive\Portfolio-CV\Refactoring\ToDo\Statistics\MBB`).

MBB накопил ~195 скилов (41 общий + 154 проектных) и работающую MCP-инфраструктуру.
Вместо того чтобы начинать с нуля, мы переносим знания из MBB в MMB постепенно —
по мере того как соответствующий код появляется в MMB.

**Почему не копируем всё сразу:**
Большинство скилов MBB описывают конкретный код MBB (компоненты, кэш, Yandex Cloud и т.д.).
Тащить их в MMB до появления этого кода — создавать мусор. Миграция идёт "по требованию".

---

## 2. Что такое скилы и зачем они нужны

Скил — это Markdown-файл с YAML-заголовком (frontmatter), который описывает
один конкретный паттерн, правило или процесс.

Пример скила:

```yaml
---
id: process-settings-sync
title: "Process: Settings Sync"
scope: process
tags: [#process, #sync, #ssot]
version: 1.0.0
updated_at: 2026-02-20
---
```

**Зачем нужны скилы (а не просто документация):**
Скилы читает MCP-сервер и отдаёт их AI-агентам (Cursor, Continue) по запросу.
Агент перед тем как что-то сделать, спрашивает: "какие скилы относятся к этому файлу?"
и получает конкретные инструкции. Это делает поведение агента предсказуемым и воспроизводимым.

Без скилов агент каждый раз "изобретает велосипед" — принимает решения на основе
общих знаний, а не правил конкретного проекта.

---

## 3. Структура папок MMB (финальная схема)

```
mmb/                              ← основной git-репозиторий
│
├── .env                          ← ТОЛЬКО корневые пути (AI_ROOT, PRO_ROOT)
│                                    меняется при переезде на другой ПК
├── .env.example                  ← шаблон без секретов (коммитится в git)
├── .gitignore
├── paths.js                      ← SSOT всех путей проекта (ESM-модуль)
│                                    все остальные файлы импортируют отсюда
├── README.md
│
├── docs/                         ← архитектурные документы для автора
│   ├── План_Skills_MCP.md        ← этот файл
│   └── ...                       ← другие планы по мере появления
│
├── mcp/                          ← серверный код MCP
│   └── skills-mcp/               ← MCP-сервер для управления скилами
│       ├── server.js             ← адаптирован из MBB, импортирует paths.js
│       └── package.json
│
├── skills/                       ← Obsidian vault + контент скилов
│   ├── .obsidian/                ← настройки Obsidian (vault открывается здесь)
│   ├── process/                  ← процессы, протоколы, жизненный цикл
│   ├── architecture/             ← архитектурные решения MMB
│   ├── integrations/             ← MCP, Continue, Docker, внешние API
│   ├── troubleshooting/          ← диагностика и решения
│   ├── security/                 ← секреты, env, границы доступа
│   ├── libs/                     ← работа с зависимостями
│   ├── drafts/                   ← черновики новых скилов (не индексируются)
│   ├── index.md                  ← мастер-индекс всех скилов (в корне vault)
│   ├── MIGRATION.md              ← живой реестр статусов миграции из MBB
│   └── README.md
│
├── scripts/                      ← автоматизация (появится позже)
├── logs/                         ← логи MCP-сервера и скриптов
└── data/                         ← данные (memory MCP и др.)
```

**Почему `skills/` — обычная папка, а не git submodule:**
В MBB `skills-core` был submodule ради двух вещей: шаринг скилов между проектами
и доступ облачного агента (GitHub Copilot Workspace) через GitHub.
В MMB скилы пока только для одного проекта, GitHub Copilot Workspace не используется.
Submodule добавил бы постоянную головную боль с синхронизацией — в MBB под это написали
два отдельных скила и автоматические проверки. Не оправдано.

**Почему нет папки `skills/skills/` (как было в MBB):**
В MBB это исторический артефакт: `skills-core/` был корнем submodule и Obsidian vault,
а внутри ещё одна `skills/` — уже сами файлы. Двойное вложение без смысла.
В MMB скилы лежат прямо в `skills/process/`, `skills/architecture/` и т.д.

**Почему Obsidian vault открывается на `skills/`, а не на всём `mmb/`:**
Vault на `skills/` — чистый граф только скилов, без шума от `.js`-файлов и логов.
Это повторяет подход MBB и работает хорошо.

**Почему нет CI/CD для скилов:**
В MBB CI/CD автоматически обновлял `index.md` при push в репозиторий скилов.
Это было нужно потому что скилы жили в отдельном репо (submodule).
В MMB скилы в основном репо — `index.md` обновляется вручную или через MCP-инструмент.

---

## 4. Реестр путей: `paths.js`

Главный урок из MBB: пути были разбросаны по трём местам —
`path-resolver.js` (4 переменные для JS), `INFRASTRUCTURE_CONFIG.yaml` (документация),
и захардкожены прямо в PowerShell-скриптах (`D:\Clouds\AO\OneDrive\AI`).
При переезде на другой ПК приходилось менять в нескольких местах.

В MMB — один файл `paths.js` как единственный источник правды для всего JS-слоя.
PowerShell-скрипты читают `.env` напрямую. Docker читает `.env` нативно.

### Группы переменных

**Группа A — корни (единственное, что меняется при смене ПК):**

| Переменная | Назначение | Пример |
|---|---|---|
| `AI_ROOT` | Корень OneDrive AI | `D:\Clouds\AO\OneDrive\AI` |
| `PRO_ROOT` | Корень проектов | `D:\Clouds\AO\OneDrive\AI\PRO` |
| `MMB_ROOT` | Корень MMB | `D:\Clouds\AO\OneDrive\AI\PRO\mmb` |

Эти три переменные живут в `.env`. Всё остальное вычисляется из них.

**Группа B — проектные пути (вычисляются из корней):**

| Переменная | Значение |
|---|---|
| `SKILLS_ROOT` | `MMB_ROOT/skills` |
| `DRAFTS_ROOT` | `MMB_ROOT/skills/drafts` |
| `LOGS_ROOT` | `MMB_ROOT/logs` |
| `DATA_ROOT` | `MMB_ROOT/data` |
| `DATASETS_ROOT` | `AI_ROOT/Projects/MMB/datasets` |

**Группа C — глобальные AI-пути (для sync-скриптов):**

| Переменная | Назначение |
|---|---|
| `GLOBAL_ROOT` | `AI_ROOT/Global` |
| `CURSOR_SSOT` | `AI_ROOT/Global/Cursor` |
| `CONTINUE_SSOT` | `AI_ROOT/Global/AO/.continue` |
| `VAULT_ROOT` | `AI_ROOT/_VAULT` |

**Группа D — Docker internal (фиксированные, не меняются никогда):**

```
/workspace/mmb      ← основной проект
/workspace/skills   ← скилы
/workspace/datasets ← данные
/workspace/global   ← глобальные настройки
```

**Группа E — MBB legacy (только на период миграции, потом удаляются):**

| Переменная | Назначение |
|---|---|
| `MBB_SKILLS_ALL` | Путь к `a/skills/all` в MBB |
| `MBB_SKILLS_MBB` | Путь к `a/skills/mbb` в MBB |

Эти переменные нужны MCP-серверу MMB чтобы читать скилы из MBB для справки
во время миграции. После завершения — удаляются из `paths.js` и `.env`.

### Как это работает на практике

```
.env                    ← только AI_ROOT, PRO_ROOT (меняется при смене ПК)
    │
    ▼
paths.js                ← читает .env, вычисляет все остальные пути
    │
    ├──► mcp/skills-mcp/server.js   (import { paths } from '../../paths.js')
    ├──► scripts/*.js               (import { paths } from '../paths.js')
    └──► control-plane/...          (import { paths } from '../paths.js')

docker-compose.yml      ← читает .env нативно, Docker-пути фиксированы
scripts/*.ps1           ← читают .env напрямую через простой парсер
```

Одно изменение в `.env` (новый `AI_ROOT`) — всё остальное подхватывается
автоматически во всех слоях.

---

## 5. MCP-сервер скилов: `mcp/skills-mcp/server.js`

Адаптируется из MBB (`mcp/skills-mcp/server.js`, версия 0.2.0).
Изменения минимальные — только пути и имена репозиториев.

### Инструменты MCP-сервера

| Инструмент | Назначение | Приоритет |
|---|---|---|
| `list_skills` | Список скилов с фильтрацией по тегам/запросу | Старт |
| `read_skill` | Чтение скила по ID | Старт |
| `search_skills` | Full-text поиск по содержимому скилов | Старт |
| `find_skills_for_file` | Какие скилы относятся к данному файлу кода | Старт |
| `audit_skill_coverage` | Какие JS-файлы не имеют skill-ссылок | Старт |
| `propose_skill` | Создание черновика нового скила | Позже |

**Почему `audit_skill_coverage` в приоритете:**
Этот инструмент проверяет, есть ли в каждом JS-файле проекта ссылки на скилы
(специальные комментарии `// Skill: ...`). Без покрытия агент не знает, какие правила
применять к конкретному файлу. Это первое что нужно выстроить при появлении кода в MMB.

**Почему `propose_skill` — позже:**
Черновики скилов нужны когда система уже работает и надо добавлять новые скилы
в процессе разработки. На старте достаточно переносить скилы вручную из MBB.

### Изменения относительно MBB

В MBB сервер знал два репозитория: `skills` (all) и `skills-mbb`.
В MMB — один репозиторий `skills`. Параметр `repo` в инструментах упрощается.

В MBB пути были частично захардкожены в самом `server.js` (строки 35–38).
В MMB сервер импортирует все пути из `paths.js` — ноль хардкода.

---

## 6. Формат скилов в MMB

Скилы используют тот же формат frontmatter что и в MBB — для совместимости
при миграции и потому что формат хорошо себя зарекомендовал.

### Стандартный frontmatter

```yaml
---
id: process-settings-sync
title: "Process: Settings Sync"
scope: process
tags: [#process, #sync, #ssot]
version: 1.0.0
priority: high
updated_at: 2026-02-20
---
```

### Дополнительные поля для мигрированных скилов (временные)

```yaml
migrated_from: mbb:process/process-settings-sync
migration_status: done        # done | partial | pending
migration_notes: "Убраны MBB-специфичные пути, обновлены relations"
```

**Почему поля миграции — в frontmatter скила, а не в отдельном реестре:**
Данные о миграции живут рядом с тем, к чему относятся. Не нужно синхронизировать
два файла. После завершения миграции — один скрипт удаляет эти три поля из всех файлов.

### Ссылки на другие скилы

В MBB встречались пути вида:
```yaml
relations: [skills-core/mbb/skills/process/process-env-key-governance.md]
```

В MMB — только ID, без путей:
```yaml
relations: [process-env-key-governance]
```

**Почему только ID:** MCP-сервер резолвит ID в физический путь сам.
Если структура папок изменится — меняется только `paths.js`, скилы не трогаем.

---

## 7. Obsidian

Vault открывается на `mmb/skills/`.

**Что настроено в `.obsidian/app.json`:**
- `"useMarkdownLinks": true` — ссылки вида `[title](../process/skill.md)`,
  а не wiki-links `[[skill]]`. Это совместимо с MCP-сервером и GitHub.

**Что исключено из индексации:**
- `drafts/` — черновики не должны попадать в граф связей

**Плагин `obsidian-local-rest-api`:**
Перенести из MBB без изменений. Позволяет читать/писать скилы через HTTP API —
пригодится для интеграции с n8n воркфлоу в будущем.

**Главное преимущество единого набора скилов в Obsidian:**
В MBB граф связей был разорван между двумя репозиториями (`all/` и `mbb/`).
Cross-links между ними не работали как backlinks в Obsidian.
В MMB один набор — граф полный и связный.

---

## 8. Категории скилов

Стартовый набор (6 категорий). Новые категории добавляются по мере появления скилов,
не создаются заранее пустыми папками:

| Категория | Что хранит |
|---|---|
| `process/` | Процессы, протоколы, жизненный цикл скилов, сессионные правила |
| `architecture/` | Архитектурные решения MMB, SSOT-схемы |
| `integrations/` | MCP, Continue AI, Docker, внешние API |
| `troubleshooting/` | Диагностика, известные проблемы и их решения |
| `security/` | Секреты, env-переменные, границы доступа |
| `libs/` | Работа с зависимостями, версионирование |

**Почему не тащим все категории из MBB:**
MBB имел 10+ категорий, часть из которых специфична для MBB-приложения:
`components/` (UI-компоненты), `cache/` (MBB-кэш), `cloud/` (Yandex Cloud),
`metrics/` (MBB-метрики), `ux/` (MBB-интерфейс). В MMB они появятся
только когда появится соответствующий код.

**Влияние количества категорий на производительность:**
Никакого. MCP-сервер рекурсивно обходит все папки. Важно только общее
количество файлов — при 500+ скилах стоит добавить кэширование в сервер.

---

## 9. Стратегия миграции скилов

### Принцип: миграция "по требованию"

Скилы не переносятся оптом. Скил переносится когда:
- В MMB появляется код, который он описывает, ИЛИ
- Скил описывает универсальный процесс (git, секреты, документация),
  актуальный с первого дня

### Источники миграции

```
MBB/skills-core/skills/all/     (~41 скил)  ← универсальные процессы
MBB/skills-core/skills/mbb/     (~154 скила) ← проектные скилы MBB
         │                              │
         └──────────┬───────────────────┘
                    ▼
         Оценка: нужен ли скил в MMB сейчас?
                    │
          ┌─────────┴──────────┐
          ▼                    ▼
    Да → переносим        Нет → пропускаем
    с адаптацией          (запись в MIGRATION.md
                           со статусом pending)
```

### Что точно НЕ мигрирует (MBB-специфика навсегда)

- `cache-keys`, `cache-strategy`, `cache-versioning` — MBB-кэш логика
- `yandex-cloud-*` — Yandex Cloud для MBB
- `components-*`, `ui-components-unified` — MBB UI-компоненты
- `metrics-portfolio-structure` — структура MBB-портфолио
- `auto-coin-sets`, `messages-*`, `workspace-config` — MBB бизнес-логика

### Что мигрирует в первую очередь

Универсальные процессы из `all/`, актуальные с первого дня:
- `process-skill-template` — шаблон скила (нужен сразу)
- `process-skills-lifecycle` — жизненный цикл скилов
- `process-skills-scope-routing` → адаптировать под MMB (одна папка вместо двух)
- `skill-secrets-hygiene` — работа с секретами
- `protocol-commit` — правила коммитов
- `process-paths-management` → адаптировать под новый `paths.js`

### Процесс переноса одного скила

1. Скопировать файл из MBB в нужную категорию `mmb/skills/`
2. Обновить frontmatter:
   - Добавить `migrated_from: mbb:путь/к/скилу`
   - Добавить `migration_status: done` (или `partial`)
   - Обновить `relations:` — заменить пути на ID
   - Убрать MBB-специфичные ссылки в тексте
3. Удалить строку из `MIGRATION.md` (раздел Pending)

### Очистка после завершения миграции

Когда все нужные скилы перенесены:
1. Удалить `mmb/skills/MIGRATION.md`
2. Запустить скрипт очистки frontmatter:
   удаляет `migrated_from`, `migration_status`, `migration_notes` из всех файлов
3. Удалить `MBB_SKILLS_ALL` и `MBB_SKILLS_MBB` из `paths.js` и `.env`

Три действия — и никаких следов миграции.

---

## 10. Связь скилов с кодом (skill anchors)

В MBB каждый JS-файл содержал ссылки на скилы двумя способами:

**Заголовок файла:**
```javascript
/**
 * Skill: process/process-settings-sync
 * Skill: security/skill-secrets-hygiene
 */
```

**Inline anchor (внутри функции):**
```javascript
// Skill anchor: root .env is SSOT for shared secrets/keys.
// See security/skill-secrets-hygiene
```

MCP-инструмент `find_skills_for_file` находит эти ссылки и возвращает
агенту список скилов, которые нужно прочитать перед редактированием файла.

`audit_skill_coverage` показывает какие файлы вообще не имеют таких ссылок —
это "белые пятна" где агент работает без правил проекта.

**В MMB этот механизм переносится без изменений.**

---

## 11. Открытые вопросы (уточнять по мере развития)

- [ ] Нужен ли `propose_skill` (создание черновиков через MCP)? Пока отложено.
- [ ] Нужна ли интеграция с n8n для автоматического обнаружения кандидатов в скилы
      (как `V2_SKILLS_MAINTENANCE` в MBB)? Пока отложено.
- [ ] Мета-скил для описания процесса миграции MBB→MMB — написать когда
      начнётся первая реальная миграция кода.
- [ ] Конфигурация Cursor MCP (`~/.cursor/mcp.json`) — прописать `skills-mmb`
      сервер при создании `mcp/skills-mcp/server.js`.
- [ ] Continue AI конфигурация — аналогично MBB, через `~/.continue/config.yaml`.

---

*Документ создан на основе анализа проекта MBB и серии архитектурных решений,
принятых в феврале 2026 года.*
