# План_External_Infrastructure_Parity.md

> Категория: Подплан migration-compatibility для внешних контуров
> Статус: Active (период миграции)
> Источники: `План_MBB_to_MMB.md`, `План_Infrastructure_Docker.md`, `План_Cloudflare.md`, `План_Yandex_Cloud.md`

---

## 1. Контекст и цель

На период миграции требуется попеременная эксплуатация MBB и MMB без потери работоспособности внешней инфраструктуры.
Фокус плана: паритет контрактов между двумя версиями для Docker/Cloudflare/Yandex Cloud и иных внешних провайдеров.

## 2. Границы и принцип паритета

- Паритет требуется на уровне контрактов (env keys, endpoints/routes, timeout/retry/fallback, health checks, deployment runbook).
- Допускается различие внутренних реализаций при сохранении эквивалентного внешнего поведения.
- Секреты и ключи ведутся только через `.env`-контур, без хранения реальных значений в репозитории.

## 3. Двунаправленный протокол синхронизации

1. Изменение в MBB внешнего контура -> обязательная проверка и отражение в MMB.
2. Изменение в MMB внешнего контура -> обязательная сверка с действующим MBB-контуром.
3. Любое изменение статуса фиксируется в `План_Migration_Sync.md`.
4. Отклонения допустимы только через явное решение `changed/replaced` с обоснованием.

## 4. Риски

- Drift конфигов и контрактов между MBB/MMB.
- Разъезд env-ключей и runtime переменных.
- Различия в retry/timeout/fallback, создающие непредсказуемые инциденты.
- Двойная операционная нагрузка и риск несинхронных релизов.

## 5. Снижение рисков

- Единый контроль через process-скил `process-external-parity-sync-governance`.
- Регулярная сверка активных внешних ключей и контрактов по чек-листу.
- Обязательная синхронизация статусов между `План_MBB_to_MMB.md` и `План_Migration_Sync.md`.
- Перед выходом из compatibility mode: подтверждение паритета и зафиксированный `replaced` для legacy-контура.

## 6. Definition of Done

- Контурные ключи и контракты внешней инфраструктуры синхронизированы в обе стороны.
- Нет критичных несовпадений для активных провайдеров.
- Для каждого провайдера определен статус: `continue`, `changed`, `replaced`, `defer`.
- План синхронизирован с мастер-планом и `План_Migration_Sync.md`.

## 7. Чек-лист

- [ ] Зафиксировать список активных внешних контуров для периода миграции.
- [x] Сверить API-ключи и env-контракты MBB↔MMB (без раскрытия секретов); перенос активных ключей в MMB выполнен.
- [x] Зафиксировать пост-переносный режим отслеживания по датам изменения `.env`/`.env.example` в обеих ветках.
- [ ] Сверить deployment/runbook контракты для Docker/Cloudflare/Yandex Cloud.
- [ ] Внести статусы `continue/changed/replaced/defer` в `План_Migration_Sync.md`.
- [ ] Обновить мастер-план после каждой существенной синхронизации.
